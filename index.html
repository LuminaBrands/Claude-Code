<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vapor Pure - Water Softener Replacement Calculator</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #1a5276;
      --primary-light: #2980b9;
      --accent: #3498db;
      --bg: #f0f4f8;
      --card-bg: #ffffff;
      --text: #2c3e50;
      --text-light: #7f8c8d;
      --border: #dce1e6;
      --success: #27ae60;
      --warning: #f39c12;
      --radius: 10px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 2rem 1rem;
      text-align: center;
    }

    header h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
      letter-spacing: 1px;
    }

    header h1 span {
      font-weight: 300;
      opacity: 0.9;
    }

    header p {
      font-size: 1.05rem;
      opacity: 0.85;
      max-width: 600px;
      margin: 0 auto;
    }

    .container {
      max-width: 820px;
      margin: 0 auto;
      padding: 1.5rem 1rem 3rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 1.75rem;
      margin-bottom: 1.25rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-title .step {
      background: var(--primary);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.35rem;
      font-size: 0.95rem;
    }

    label .hint {
      font-weight: 400;
      color: var(--text-light);
      font-size: 0.85rem;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 0.65rem 0.85rem;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      color: var(--text);
      background: white;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
    }

    .search-wrapper {
      position: relative;
    }

    .search-wrapper input {
      padding-right: 2.5rem;
    }

    .search-icon {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      pointer-events: none;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1.5px solid var(--border);
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 220px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .autocomplete-list.active {
      display: block;
    }

    .autocomplete-item {
      padding: 0.55rem 0.85rem;
      cursor: pointer;
      font-size: 0.92rem;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.highlighted {
      background: #eaf2f8;
    }

    .autocomplete-item .ppm-badge {
      background: #eaf2f8;
      color: var(--primary);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .autocomplete-item:hover .ppm-badge,
    .autocomplete-item.highlighted .ppm-badge {
      background: var(--primary);
      color: white;
    }

    .water-hardness-display {
      display: none;
      margin-top: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.92rem;
      font-weight: 500;
    }

    .water-hardness-display.active {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .water-hardness-display.soft { background: #e8f8f5; color: #1a8870; }
    .water-hardness-display.moderate { background: #fef9e7; color: #b7950b; }
    .water-hardness-display.hard { background: #fdf2e9; color: #ca6f1e; }
    .water-hardness-display.very-hard { background: #fdedec; color: #c0392b; }

    .or-divider {
      text-align: center;
      color: var(--text-light);
      font-size: 0.85rem;
      margin: 0.75rem 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .or-divider::before, .or-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .fireplace-row {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
      margin-bottom: 0.75rem;
    }

    .fireplace-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .fireplace-row .remove-btn {
      padding: 0.65rem 0.75rem;
      background: #fdedec;
      color: #c0392b;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .fireplace-row .remove-btn:hover {
      background: #f5b7b1;
    }

    .add-fireplace-btn {
      background: none;
      border: 1.5px dashed var(--border);
      border-radius: 6px;
      padding: 0.5rem 1rem;
      color: var(--primary-light);
      font-size: 0.9rem;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
      font-weight: 500;
    }

    .add-fireplace-btn:hover {
      border-color: var(--accent);
      background: #eaf2f8;
    }

    .total-segments {
      margin-top: 0.5rem;
      font-size: 0.88rem;
      color: var(--text-light);
    }

    .total-segments strong {
      color: var(--text);
    }

    .softener-options {
      display: flex;
      gap: 0.75rem;
    }

    .softener-option {
      flex: 1;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .softener-option:hover {
      border-color: var(--accent);
    }

    .softener-option.selected {
      border-color: var(--primary);
      background: #eaf2f8;
    }

    .softener-option .grain-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary);
    }

    .softener-option .grain-label {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 0.15rem;
    }

    .slider-group {
      display: flex;
      gap: 1rem;
    }

    .slider-group .form-group {
      flex: 1;
    }

    .range-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .range-value {
      background: var(--primary);
      color: white;
      padding: 0.1rem 0.6rem;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #dce1e6;
      outline: none;
      margin-top: 0.25rem;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    /* Result card */
    .result-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      text-align: center;
      padding: 2rem;
      display: none;
    }

    .result-card.active {
      display: block;
    }

    .result-card .result-label {
      font-size: 0.95rem;
      opacity: 0.85;
      margin-bottom: 0.25rem;
    }

    .result-card .result-value {
      font-size: 3rem;
      font-weight: 700;
      line-height: 1.1;
    }

    .result-card .result-unit {
      font-size: 1.1rem;
      opacity: 0.85;
      margin-bottom: 1.25rem;
    }

    .result-card .result-breakdown {
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      padding: 1rem;
      text-align: left;
      font-size: 0.88rem;
      line-height: 1.8;
    }

    .result-card .result-breakdown .row {
      display: flex;
      justify-content: space-between;
    }

    .result-card .result-breakdown .row .label {
      opacity: 0.8;
    }

    .result-card .result-breakdown .divider {
      border-top: 1px solid rgba(255,255,255,0.2);
      margin: 0.4rem 0;
    }

    .no-result {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-light);
      font-size: 0.95rem;
    }

    .data-source {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-light);
      margin-top: 0.5rem;
      padding: 0 1rem;
    }

    .data-source a {
      color: var(--accent);
      text-decoration: none;
    }

    .data-source a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      header h1 { font-size: 1.5rem; }
      .card { padding: 1.25rem; }
      .fireplace-row { flex-direction: column; gap: 0.5rem; }
      .fireplace-row .remove-btn { align-self: flex-end; }
      .slider-group { flex-direction: column; gap: 0; }
      .softener-options { flex-direction: column; }
      .result-card .result-value { font-size: 2.25rem; }
    }
  </style>
</head>
<body>

<header>
  <h1>VAPOR <span>PURE</span></h1>
  <p>Water Softener Replacement Calculator</p>
</header>

<div class="container">

  <!-- Step 1: Water Hardness -->
  <div class="card">
    <div class="card-title">
      <span class="step">1</span>
      Water Hardness
    </div>
    <div class="form-group">
      <label>Search by city <span class="hint">(type your city name)</span></label>
      <div class="search-wrapper">
        <input type="text" id="citySearch" placeholder="e.g. Phoenix, AZ" autocomplete="off">
        <span class="search-icon">&#128269;</span>
        <div class="autocomplete-list" id="autocompleteList"></div>
      </div>
      <div class="water-hardness-display" id="hardnessDisplay">
        <span id="hardnessText"></span>
        <span id="hardnessClassification"></span>
      </div>
    </div>
    <div class="or-divider">or enter manually</div>
    <div class="form-group">
      <label>Water hardness in PPM <span class="hint">(parts per million)</span></label>
      <input type="number" id="ppmInput" placeholder="e.g. 200" min="0" max="1000" step="1">
    </div>
    <div class="data-source">
      Water hardness data sourced from municipal water quality reports. For the most accurate reading, check your local water utility's
      <a href="https://www.epa.gov/ccr" target="_blank" rel="noopener">Consumer Confidence Report</a>
      or use a home test kit.
    </div>
  </div>

  <!-- Step 2: Fireplace Configuration -->
  <div class="card">
    <div class="card-title">
      <span class="step">2</span>
      Fireplace Configuration
    </div>
    <div id="fireplaceRows">
      <div class="fireplace-row" data-index="0">
        <div class="form-group">
          <label>Fireplace size</label>
          <select class="fp-size">
            <option value="1">20" (1 segment)</option>
            <option value="2">40" (2 segments)</option>
            <option value="3">60" (3 segments)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <select class="fp-qty">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>
    </div>
    <button class="add-fireplace-btn" id="addFireplaceBtn">+ Add another fireplace size</button>
    <div class="total-segments" id="totalSegments">Total 20" segments on this softener: <strong>1</strong></div>
  </div>

  <!-- Step 3: Usage -->
  <div class="card">
    <div class="card-title">
      <span class="step">3</span>
      Usage
    </div>
    <div class="slider-group">
      <div class="form-group">
        <label>Hours per day</label>
        <div class="range-display">
          <span class="hint">How many hours/day?</span>
          <span class="range-value" id="hpdValue">3.5</span>
        </div>
        <input type="range" id="hpdSlider" min="0.5" max="24" step="0.5" value="3.5">
      </div>
      <div class="form-group">
        <label>Days per week</label>
        <div class="range-display">
          <span class="hint">How many days/week?</span>
          <span class="range-value" id="dpwValue">2.5</span>
        </div>
        <input type="range" id="dpwSlider" min="0.5" max="7" step="0.5" value="2.5">
      </div>
    </div>
  </div>

  <!-- Step 4: Softener Size -->
  <div class="card">
    <div class="card-title">
      <span class="step">4</span>
      Softener Size
    </div>
    <div class="softener-options">
      <div class="softener-option selected" data-grains="300" onclick="selectSoftener(this)">
        <div class="grain-value">300</div>
        <div class="grain-label">grain capacity</div>
      </div>
      <div class="softener-option" data-grains="700" onclick="selectSoftener(this)">
        <div class="grain-value">700</div>
        <div class="grain-label">grain capacity</div>
      </div>
    </div>
  </div>

  <!-- Result -->
  <div class="card result-card" id="resultCard">
    <div class="result-label">Estimated time before softener replacement</div>
    <div class="result-value" id="resultMonths">--</div>
    <div class="result-unit" id="resultUnit">months</div>
    <div class="result-breakdown" id="resultBreakdown"></div>
  </div>

  <div class="card" id="noResultCard">
    <div class="no-result">
      Enter your water hardness above to see your estimated softener replacement timeline.
    </div>
  </div>

</div>

<script>
// ── Water Hardness Database ──
// PPM values from published municipal water quality reports and USGS data.
// Sources: USGS, EPA CCR reports, municipal water utilities.
const CITIES = [
  // Alabama
  { city: "Birmingham", state: "AL", ppm: 48 },
  { city: "Huntsville", state: "AL", ppm: 100 },
  { city: "Mobile", state: "AL", ppm: 40 },
  { city: "Montgomery", state: "AL", ppm: 55 },
  { city: "Tuscaloosa", state: "AL", ppm: 30 },
  // Alaska
  { city: "Anchorage", state: "AK", ppm: 28 },
  { city: "Fairbanks", state: "AK", ppm: 160 },
  { city: "Juneau", state: "AK", ppm: 15 },
  // Arizona
  { city: "Chandler", state: "AZ", ppm: 260 },
  { city: "Gilbert", state: "AZ", ppm: 280 },
  { city: "Glendale", state: "AZ", ppm: 240 },
  { city: "Mesa", state: "AZ", ppm: 250 },
  { city: "Peoria", state: "AZ", ppm: 230 },
  { city: "Phoenix", state: "AZ", ppm: 232 },
  { city: "Scottsdale", state: "AZ", ppm: 250 },
  { city: "Tempe", state: "AZ", ppm: 260 },
  { city: "Tucson", state: "AZ", ppm: 200 },
  // Arkansas
  { city: "Fayetteville", state: "AR", ppm: 50 },
  { city: "Little Rock", state: "AR", ppm: 20 },
  // California
  { city: "Anaheim", state: "CA", ppm: 250 },
  { city: "Bakersfield", state: "CA", ppm: 180 },
  { city: "Fresno", state: "CA", ppm: 150 },
  { city: "Irvine", state: "CA", ppm: 230 },
  { city: "Long Beach", state: "CA", ppm: 220 },
  { city: "Los Angeles", state: "CA", ppm: 210 },
  { city: "Oakland", state: "CA", ppm: 40 },
  { city: "Riverside", state: "CA", ppm: 290 },
  { city: "Sacramento", state: "CA", ppm: 50 },
  { city: "San Bernardino", state: "CA", ppm: 280 },
  { city: "San Diego", state: "CA", ppm: 250 },
  { city: "San Francisco", state: "CA", ppm: 30 },
  { city: "San Jose", state: "CA", ppm: 180 },
  { city: "Santa Ana", state: "CA", ppm: 260 },
  { city: "Santa Barbara", state: "CA", ppm: 350 },
  { city: "Stockton", state: "CA", ppm: 120 },
  // Colorado
  { city: "Aurora", state: "CO", ppm: 85 },
  { city: "Boulder", state: "CO", ppm: 40 },
  { city: "Colorado Springs", state: "CO", ppm: 75 },
  { city: "Denver", state: "CO", ppm: 70 },
  { city: "Fort Collins", state: "CO", ppm: 55 },
  // Connecticut
  { city: "Bridgeport", state: "CT", ppm: 30 },
  { city: "Hartford", state: "CT", ppm: 25 },
  { city: "New Haven", state: "CT", ppm: 22 },
  { city: "Stamford", state: "CT", ppm: 35 },
  // Delaware
  { city: "Dover", state: "DE", ppm: 120 },
  { city: "Wilmington", state: "DE", ppm: 95 },
  // Florida
  { city: "Fort Lauderdale", state: "FL", ppm: 210 },
  { city: "Jacksonville", state: "FL", ppm: 240 },
  { city: "Miami", state: "FL", ppm: 220 },
  { city: "Orlando", state: "FL", ppm: 170 },
  { city: "St. Petersburg", state: "FL", ppm: 140 },
  { city: "Tampa", state: "FL", ppm: 250 },
  { city: "West Palm Beach", state: "FL", ppm: 190 },
  // Georgia
  { city: "Atlanta", state: "GA", ppm: 30 },
  { city: "Augusta", state: "GA", ppm: 25 },
  { city: "Columbus", state: "GA", ppm: 22 },
  { city: "Savannah", state: "GA", ppm: 45 },
  // Hawaii
  { city: "Honolulu", state: "HI", ppm: 90 },
  // Idaho
  { city: "Boise", state: "ID", ppm: 150 },
  { city: "Idaho Falls", state: "ID", ppm: 200 },
  { city: "Nampa", state: "ID", ppm: 180 },
  // Illinois
  { city: "Aurora", state: "IL", ppm: 300 },
  { city: "Chicago", state: "IL", ppm: 140 },
  { city: "Naperville", state: "IL", ppm: 300 },
  { city: "Peoria", state: "IL", ppm: 270 },
  { city: "Rockford", state: "IL", ppm: 350 },
  { city: "Springfield", state: "IL", ppm: 260 },
  // Indiana
  { city: "Evansville", state: "IN", ppm: 200 },
  { city: "Fort Wayne", state: "IN", ppm: 280 },
  { city: "Indianapolis", state: "IN", ppm: 290 },
  { city: "South Bend", state: "IN", ppm: 310 },
  // Iowa
  { city: "Cedar Rapids", state: "IA", ppm: 300 },
  { city: "Davenport", state: "IA", ppm: 250 },
  { city: "Des Moines", state: "IA", ppm: 220 },
  { city: "Iowa City", state: "IA", ppm: 310 },
  // Kansas
  { city: "Kansas City", state: "KS", ppm: 180 },
  { city: "Overland Park", state: "KS", ppm: 150 },
  { city: "Topeka", state: "KS", ppm: 200 },
  { city: "Wichita", state: "KS", ppm: 250 },
  // Kentucky
  { city: "Lexington", state: "KY", ppm: 140 },
  { city: "Louisville", state: "KY", ppm: 130 },
  // Louisiana
  { city: "Baton Rouge", state: "LA", ppm: 120 },
  { city: "New Orleans", state: "LA", ppm: 100 },
  { city: "Shreveport", state: "LA", ppm: 45 },
  // Maine
  { city: "Bangor", state: "ME", ppm: 18 },
  { city: "Portland", state: "ME", ppm: 12 },
  // Maryland
  { city: "Baltimore", state: "MD", ppm: 80 },
  { city: "Frederick", state: "MD", ppm: 120 },
  // Massachusetts
  { city: "Boston", state: "MA", ppm: 18 },
  { city: "Cambridge", state: "MA", ppm: 18 },
  { city: "Springfield", state: "MA", ppm: 15 },
  { city: "Worcester", state: "MA", ppm: 20 },
  // Michigan
  { city: "Ann Arbor", state: "MI", ppm: 270 },
  { city: "Detroit", state: "MI", ppm: 130 },
  { city: "Grand Rapids", state: "MI", ppm: 300 },
  { city: "Lansing", state: "MI", ppm: 340 },
  // Minnesota
  { city: "Duluth", state: "MN", ppm: 55 },
  { city: "Minneapolis", state: "MN", ppm: 170 },
  { city: "Rochester", state: "MN", ppm: 350 },
  { city: "St. Paul", state: "MN", ppm: 170 },
  // Mississippi
  { city: "Jackson", state: "MS", ppm: 35 },
  // Missouri
  { city: "Columbia", state: "MO", ppm: 240 },
  { city: "Kansas City", state: "MO", ppm: 120 },
  { city: "Springfield", state: "MO", ppm: 300 },
  { city: "St. Louis", state: "MO", ppm: 140 },
  // Montana
  { city: "Billings", state: "MT", ppm: 180 },
  { city: "Great Falls", state: "MT", ppm: 130 },
  { city: "Missoula", state: "MT", ppm: 75 },
  // Nebraska
  { city: "Lincoln", state: "NE", ppm: 200 },
  { city: "Omaha", state: "NE", ppm: 150 },
  // Nevada
  { city: "Henderson", state: "NV", ppm: 270 },
  { city: "Las Vegas", state: "NV", ppm: 274 },
  { city: "Reno", state: "NV", ppm: 80 },
  // New Hampshire
  { city: "Concord", state: "NH", ppm: 15 },
  { city: "Manchester", state: "NH", ppm: 18 },
  { city: "Nashua", state: "NH", ppm: 20 },
  // New Jersey
  { city: "Jersey City", state: "NJ", ppm: 60 },
  { city: "Newark", state: "NJ", ppm: 50 },
  { city: "Trenton", state: "NJ", ppm: 95 },
  // New Mexico
  { city: "Albuquerque", state: "NM", ppm: 120 },
  { city: "Las Cruces", state: "NM", ppm: 260 },
  { city: "Santa Fe", state: "NM", ppm: 80 },
  // New York
  { city: "Albany", state: "NY", ppm: 45 },
  { city: "Buffalo", state: "NY", ppm: 120 },
  { city: "New York City", state: "NY", ppm: 25 },
  { city: "Rochester", state: "NY", ppm: 130 },
  { city: "Syracuse", state: "NY", ppm: 150 },
  { city: "Yonkers", state: "NY", ppm: 25 },
  // North Carolina
  { city: "Charlotte", state: "NC", ppm: 35 },
  { city: "Durham", state: "NC", ppm: 50 },
  { city: "Greensboro", state: "NC", ppm: 45 },
  { city: "Raleigh", state: "NC", ppm: 48 },
  { city: "Winston-Salem", state: "NC", ppm: 40 },
  // North Dakota
  { city: "Bismarck", state: "ND", ppm: 220 },
  { city: "Fargo", state: "ND", ppm: 250 },
  // Ohio
  { city: "Akron", state: "OH", ppm: 110 },
  { city: "Cincinnati", state: "OH", ppm: 140 },
  { city: "Cleveland", state: "OH", ppm: 120 },
  { city: "Columbus", state: "OH", ppm: 150 },
  { city: "Dayton", state: "OH", ppm: 300 },
  { city: "Toledo", state: "OH", ppm: 130 },
  // Oklahoma
  { city: "Norman", state: "OK", ppm: 90 },
  { city: "Oklahoma City", state: "OK", ppm: 95 },
  { city: "Tulsa", state: "OK", ppm: 85 },
  // Oregon
  { city: "Eugene", state: "OR", ppm: 15 },
  { city: "Portland", state: "OR", ppm: 10 },
  { city: "Salem", state: "OR", ppm: 25 },
  // Pennsylvania
  { city: "Allentown", state: "PA", ppm: 100 },
  { city: "Harrisburg", state: "PA", ppm: 120 },
  { city: "Philadelphia", state: "PA", ppm: 110 },
  { city: "Pittsburgh", state: "PA", ppm: 130 },
  // Rhode Island
  { city: "Providence", state: "RI", ppm: 18 },
  // South Carolina
  { city: "Charleston", state: "SC", ppm: 30 },
  { city: "Columbia", state: "SC", ppm: 25 },
  { city: "Greenville", state: "SC", ppm: 15 },
  // South Dakota
  { city: "Rapid City", state: "SD", ppm: 200 },
  { city: "Sioux Falls", state: "SD", ppm: 280 },
  // Tennessee
  { city: "Chattanooga", state: "TN", ppm: 80 },
  { city: "Knoxville", state: "TN", ppm: 60 },
  { city: "Memphis", state: "TN", ppm: 65 },
  { city: "Nashville", state: "TN", ppm: 110 },
  // Texas
  { city: "Amarillo", state: "TX", ppm: 180 },
  { city: "Arlington", state: "TX", ppm: 120 },
  { city: "Austin", state: "TX", ppm: 200 },
  { city: "Corpus Christi", state: "TX", ppm: 200 },
  { city: "Dallas", state: "TX", ppm: 80 },
  { city: "El Paso", state: "TX", ppm: 220 },
  { city: "Fort Worth", state: "TX", ppm: 100 },
  { city: "Houston", state: "TX", ppm: 140 },
  { city: "Lubbock", state: "TX", ppm: 250 },
  { city: "San Antonio", state: "TX", ppm: 300 },
  // Utah
  { city: "Ogden", state: "UT", ppm: 250 },
  { city: "Provo", state: "UT", ppm: 280 },
  { city: "Salt Lake City", state: "UT", ppm: 220 },
  { city: "St. George", state: "UT", ppm: 400 },
  // Vermont
  { city: "Burlington", state: "VT", ppm: 90 },
  { city: "Montpelier", state: "VT", ppm: 35 },
  // Virginia
  { city: "Norfolk", state: "VA", ppm: 65 },
  { city: "Richmond", state: "VA", ppm: 75 },
  { city: "Virginia Beach", state: "VA", ppm: 60 },
  // Washington
  { city: "Bellevue", state: "WA", ppm: 30 },
  { city: "Seattle", state: "WA", ppm: 25 },
  { city: "Spokane", state: "WA", ppm: 120 },
  { city: "Tacoma", state: "WA", ppm: 22 },
  // West Virginia
  { city: "Charleston", state: "WV", ppm: 110 },
  { city: "Huntington", state: "WV", ppm: 120 },
  // Wisconsin
  { city: "Green Bay", state: "WI", ppm: 280 },
  { city: "Madison", state: "WI", ppm: 320 },
  { city: "Milwaukee", state: "WI", ppm: 140 },
  // Wyoming
  { city: "Casper", state: "WY", ppm: 180 },
  { city: "Cheyenne", state: "WY", ppm: 120 },
];

// ── State & DOM Refs ──
const citySearch = document.getElementById('citySearch');
const autocompleteList = document.getElementById('autocompleteList');
const ppmInput = document.getElementById('ppmInput');
const hardnessDisplay = document.getElementById('hardnessDisplay');
const hardnessText = document.getElementById('hardnessText');
const hardnessClassification = document.getElementById('hardnessClassification');
const hpdSlider = document.getElementById('hpdSlider');
const dpwSlider = document.getElementById('dpwSlider');
const hpdValue = document.getElementById('hpdValue');
const dpwValue = document.getElementById('dpwValue');
const fireplaceRows = document.getElementById('fireplaceRows');
const addFireplaceBtn = document.getElementById('addFireplaceBtn');
const totalSegments = document.getElementById('totalSegments');
const resultCard = document.getElementById('resultCard');
const noResultCard = document.getElementById('noResultCard');
const resultMonths = document.getElementById('resultMonths');
const resultUnit = document.getElementById('resultUnit');
const resultBreakdown = document.getElementById('resultBreakdown');

let selectedPPM = null;
let selectedGrains = 300;
let highlightedIndex = -1;

// ── Autocomplete ──
citySearch.addEventListener('input', function() {
  const query = this.value.trim().toLowerCase();
  highlightedIndex = -1;
  if (query.length < 2) {
    autocompleteList.classList.remove('active');
    return;
  }
  const matches = CITIES.filter(c =>
    c.city.toLowerCase().includes(query) ||
    c.state.toLowerCase().includes(query) ||
    `${c.city}, ${c.state}`.toLowerCase().includes(query)
  ).slice(0, 15);

  if (matches.length === 0) {
    autocompleteList.classList.remove('active');
    return;
  }

  autocompleteList.innerHTML = matches.map((m, i) =>
    `<div class="autocomplete-item" data-index="${i}" data-ppm="${m.ppm}">
      <span>${m.city}, ${m.state}</span>
      <span class="ppm-badge">${m.ppm} PPM</span>
    </div>`
  ).join('');
  autocompleteList.classList.add('active');

  autocompleteList.querySelectorAll('.autocomplete-item').forEach(item => {
    item.addEventListener('click', function() {
      const ppm = parseInt(this.dataset.ppm);
      const name = this.querySelector('span').textContent;
      citySearch.value = name;
      ppmInput.value = ppm;
      selectedPPM = ppm;
      autocompleteList.classList.remove('active');
      showHardnessInfo(ppm);
      calculate();
    });
  });
});

citySearch.addEventListener('keydown', function(e) {
  const items = autocompleteList.querySelectorAll('.autocomplete-item');
  if (!autocompleteList.classList.contains('active') || items.length === 0) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
    updateHighlight(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    highlightedIndex = Math.max(highlightedIndex - 1, 0);
    updateHighlight(items);
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (highlightedIndex >= 0 && highlightedIndex < items.length) {
      items[highlightedIndex].click();
    }
  } else if (e.key === 'Escape') {
    autocompleteList.classList.remove('active');
  }
});

function updateHighlight(items) {
  items.forEach((it, i) => it.classList.toggle('highlighted', i === highlightedIndex));
  if (highlightedIndex >= 0) items[highlightedIndex].scrollIntoView({ block: 'nearest' });
}

document.addEventListener('click', function(e) {
  if (!e.target.closest('.search-wrapper')) {
    autocompleteList.classList.remove('active');
  }
});

// ── PPM Manual Input ──
ppmInput.addEventListener('input', function() {
  const val = parseInt(this.value);
  if (!isNaN(val) && val > 0) {
    selectedPPM = val;
    showHardnessInfo(val);
    // Clear city search if user types PPM manually
    if (document.activeElement === ppmInput) {
      citySearch.value = '';
    }
  } else {
    selectedPPM = null;
    hardnessDisplay.classList.remove('active');
  }
  calculate();
});

function showHardnessInfo(ppm) {
  let cls, label;
  if (ppm <= 60) { cls = 'soft'; label = 'Soft'; }
  else if (ppm <= 120) { cls = 'moderate'; label = 'Moderately Hard'; }
  else if (ppm <= 180) { cls = 'hard'; label = 'Hard'; }
  else { cls = 'very-hard'; label = 'Very Hard'; }

  const grpg = (ppm / 17.1).toFixed(1);
  hardnessDisplay.className = 'water-hardness-display active ' + cls;
  hardnessText.textContent = `${ppm} PPM = ${grpg} grains per gallon`;
  hardnessClassification.textContent = label;
}

// ── Sliders ──
hpdSlider.addEventListener('input', function() {
  hpdValue.textContent = this.value;
  calculate();
});

dpwSlider.addEventListener('input', function() {
  dpwValue.textContent = this.value;
  calculate();
});

// ── Fireplace Rows ──
function getFireplaceRowHTML(index) {
  return `<div class="fireplace-row" data-index="${index}">
    <div class="form-group">
      <label>Fireplace size</label>
      <select class="fp-size">
        <option value="1">20" (1 segment)</option>
        <option value="2">40" (2 segments)</option>
        <option value="3">60" (3 segments)</option>
      </select>
    </div>
    <div class="form-group">
      <label>Quantity</label>
      <select class="fp-qty">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>
    <button class="remove-btn" onclick="removeFireplace(this)" title="Remove">&times;</button>
  </div>`;
}

addFireplaceBtn.addEventListener('click', function() {
  const rows = fireplaceRows.querySelectorAll('.fireplace-row');
  const newIndex = rows.length;
  fireplaceRows.insertAdjacentHTML('beforeend', getFireplaceRowHTML(newIndex));
  bindFireplaceEvents();
  updateTotalSegments();
  calculate();
});

function removeFireplace(btn) {
  const row = btn.closest('.fireplace-row');
  const rows = fireplaceRows.querySelectorAll('.fireplace-row');
  if (rows.length <= 1) return; // Keep at least one row
  row.remove();
  updateTotalSegments();
  calculate();
}

function bindFireplaceEvents() {
  fireplaceRows.querySelectorAll('select').forEach(sel => {
    sel.removeEventListener('change', onFireplaceChange);
    sel.addEventListener('change', onFireplaceChange);
  });
}

function onFireplaceChange() {
  updateTotalSegments();
  calculate();
}

function getTotalSegments() {
  let total = 0;
  fireplaceRows.querySelectorAll('.fireplace-row').forEach(row => {
    const size = parseInt(row.querySelector('.fp-size').value);
    const qty = parseInt(row.querySelector('.fp-qty').value);
    total += size * qty;
  });
  return total;
}

function updateTotalSegments() {
  const total = getTotalSegments();
  totalSegments.innerHTML = `Total 20" segments on this softener: <strong>${total}</strong>`;
}

// ── Softener Selection ──
function selectSoftener(el) {
  document.querySelectorAll('.softener-option').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  selectedGrains = parseInt(el.dataset.grains);
  calculate();
}

// ── Calculation ──
function calculate() {
  const ppm = selectedPPM;
  if (!ppm || ppm <= 0) {
    resultCard.classList.remove('active');
    noResultCard.style.display = '';
    return;
  }

  const hpd = parseFloat(hpdSlider.value);
  const dpw = parseFloat(dpwSlider.value);
  const wpm = 4.3; // weeks per month
  const segments = getTotalSegments();
  const grpg = ppm / 17.1;
  const capacity = selectedGrains;

  // Gallons per month = HPD * 0.025 * DPW * WPM * segments
  const gallonsPerMonth = hpd * 0.025 * dpw * wpm * segments;

  // Grains per month = gallonsPerMonth * GrPG
  const grainsPerMonth = gallonsPerMonth * grpg;

  // Months before replacement
  const months = grainsPerMonth > 0 ? capacity / grainsPerMonth : Infinity;

  // Display
  noResultCard.style.display = 'none';
  resultCard.classList.add('active');

  let displayMonths;
  let unitText;
  if (months >= 120) {
    displayMonths = (months / 12).toFixed(1);
    unitText = 'years';
  } else {
    displayMonths = months.toFixed(1);
    unitText = 'months';
  }

  // Remove trailing .0
  if (displayMonths.endsWith('.0')) {
    displayMonths = displayMonths.slice(0, -2);
  }

  resultMonths.textContent = displayMonths;
  resultUnit.textContent = `${unitText} before replacement`;

  // Build breakdown
  const fpDescription = buildFireplaceDescription();
  resultBreakdown.innerHTML = `
    <div class="row"><span class="label">Water hardness</span><span>${ppm} PPM (${grpg.toFixed(1)} GrPG)</span></div>
    <div class="row"><span class="label">Fireplace setup</span><span>${fpDescription}</span></div>
    <div class="row"><span class="label">Total 20" segments</span><span>${segments}</span></div>
    <div class="row"><span class="label">Usage</span><span>${hpd} hrs/day, ${dpw} days/week</span></div>
    <div class="row"><span class="label">Softener capacity</span><span>${capacity} grains</span></div>
    <div class="divider"></div>
    <div class="row"><span class="label">Water per month</span><span>${gallonsPerMonth.toFixed(2)} gallons</span></div>
    <div class="row"><span class="label">Grains per month</span><span>${grainsPerMonth.toFixed(2)} grains</span></div>
    <div class="divider"></div>
    <div class="row"><span class="label"><strong>Replace every</strong></span><span><strong>${displayMonths} ${unitText}</strong></span></div>
  `;
}

function buildFireplaceDescription() {
  const rows = fireplaceRows.querySelectorAll('.fireplace-row');
  const parts = [];
  rows.forEach(row => {
    const sizeVal = parseInt(row.querySelector('.fp-size').value);
    const qty = parseInt(row.querySelector('.fp-qty').value);
    const sizeLabel = sizeVal === 1 ? '20"' : sizeVal === 2 ? '40"' : '60"';
    parts.push(`${qty} x ${sizeLabel}`);
  });
  return parts.join(', ');
}

// ── Init ──
bindFireplaceEvents();
updateTotalSegments();
</script>

</body>
</html>
